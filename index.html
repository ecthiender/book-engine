<!DOCTYPE html>
<html lang="en">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title> Book Engine Demo </title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
	body
	{
	 /*background-color:#121212;*/
	}
	</style>
  <!--script src="../jquery-1.9.0.js"></script-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
	<script type="text/javascript" src="js/lib/three.js"></script>
	<script type="text/javascript" src="js/lib/MOD3.js"></script>
	<script type="text/javascript" src="js/lib/Tween.js"></script>
	<script type="text/javascript" src="js/lib/reqanim.js"></script>
	<script type="text/javascript" src="js/FlipBook3D.js"></script>
	</head>
	<body>
		<div id="controls" style="position:absolute;z-index:1000">
		<input type="button" id="flipleft" value="flipLeft" />
		<br />
		<input type="button" id="flipright" value="flipRight" />
		<br />
		<input type="button" id="magnify" value="Magnify Off"/>
		</div>
		<div id="container" style="position:relative;margin:0 auto;padding:0;z-index:0;cursor:pointer;"></div>
		<script>
			var container;
			var camera, scene, renderer, projector, clock, mag_cam;
      var clientX, clientY, magnify = false;

			var targetRotationY = 0;
			var targetRotationOnMouseDownY = 0;
			var targetRotationX = 0;
			var targetRotationOnMouseDownX = 0;
			var rad = 200;
			var mouse={x:0,y:0};
			var mouseX = 0;
			var mouseXOnMouseDown = 0;
			var mouseY = 0;
			var mouseYOnMouseDown = 0;
			var mstack,bend;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			var w,h,w2,h2;
			var book, test_book;
			var pagew = 80;
			var pageh = pagew * 10/7;
			var fl,fr;

      var max_allowed_pages = 20;
      var max_pages;
      var fetched = 0;

      var controls;

      $.getJSON('books.json', function(books) {
        test_book = books[0];
        max_pages = (test_book.pages > max_allowed_pages) ? max_allowed_pages : test_book.pages;
			  init();
			  animate();
      });


			function init() {

				container=document.getElementById('container');
				w=window.innerWidth;
				h=window.innerHeight;
				w2=w/2;
				h2=h/2;
				container.style.width=w+"px";
				container.style.height=h+"px";
				container.style.marginTop=0.5*(window.innerHeight-h)+'px';

        clock = new THREE.Clock();
				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 45, w / h, 0.1, 10000 );
        camera.position.z = rad;
				scene.add( camera );

        //book_cam = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
        //scene.add(book_cam);

        /*mag_cam = new THREE.OrthographicCamera(
          window.innerWidth / -4,// Left
          window.innerWidth / 4,// Right
          window.innerHeight / 4,// Top
          window.innerHeight / -4,// Bottom
          1,            // Near 
          100);           // Far -- enough to see the skybox
        //topCamera.up = new THREE.Vector3(0,0,-1)  ;*/
        mag_cam  = new THREE.PerspectiveCamera(45, w/h, 0.1, 10000);
        mag_cam.position.set(0, 0, 60);
        mag_cam.lookAt(scene.position);
        scene.add(mag_cam)    
				
				projector = new THREE.Projector();

				// webgl renderer gives better rendering without problems
				renderer = new THREE.WebGLRenderer();
				renderer.setSize( w, h );
        renderer.setClearColorHex( 0x000000, 1 );
        renderer.autoClear = false;

				container.appendChild( renderer.domElement );

				container.addEventListener( 'mousedown', onDocumentMouseDown, false );
        container.addEventListener( 'mousemove', onMousemoveForMag, false );

				book=new FlipBook3D.Book();
				book.pageWidth=pagew;
				book.pageHeight=pageh;
				scene.add(book);


        for(var i=0; i<max_pages; i+=2) {
          //var texturefront = t.ImageUtils.loadTexture(images[i].f);
          var texturefront = THREE.ImageUtils.loadTexture(test_book.url + i + '.jpg');
          var textureback = THREE.ImageUtils.loadTexture(test_book.url + (i+1) + '.jpg');
          book.addPage(texturefront, textureback, 0);
          fetched = i;
        }
        console.log('fetched', fetched);

				fl=document.getElementById('flipleft');
				fr=document.getElementById('flipright');
        fl.addEventListener('click',function(){
          book.pages[book.pages.length-book.flippedright].flipLeft()
          prefetch();
        });
        fr.addEventListener('click',function(){
          book.pages[book.flippedleft-1].flipRight()
          prefetch();
        });
        var mag = document.getElementById('magnify');
        mag.addEventListener('click', function(event) {
          if(magnify == true) {
            mag.value = "Magnify Off";
            magnify = false;
          }
          else {
            mag.value = "Magnify On";
            magnify = true;
          }
        });
			}

      function prefetch() {
        var pageno = book.flippedleft * 2;
        if(test_book.pages < max_allowed_pages) {
          return;
        }
        if(pageno <= fetched - 5) {
          return;
        }
        console.log('fetching books..');
        var load_pages = fetched + 20;
        if(load_pages > test_book.pages) {
          return;
        }
        for(var i = fetched + 1; i < load_pages; i += 2) {
          var texturefront = THREE.ImageUtils.loadTexture(test_book.url + i + '.jpg');
          var textureback = THREE.ImageUtils.loadTexture(test_book.url + (i+1) + '.jpg');
          book.addPage(texturefront, textureback, 0);
          fetched = i;
        }
      }

			function onDocumentMouseDown( event ) {
				event.preventDefault();
				mouseX=(( event.clientX / w ) * 2 - 1);
				targetRotationY=mouseX;
				mouseY=(( event.clientY / h ) * 2 - 1);
				targetRotationX=mouseY;
				container.addEventListener( 'mousemove', onDocumentMouseMove, false );
				container.addEventListener( 'mouseup', onDocumentMouseUp, false );
				container.addEventListener( 'mouseout', onDocumentMouseOut, false );
				//window.addEventListener( 'keydown', onKeyDown, false );
				//window.addEventListener( 'keyup', onKeyUp, false );
			}

			function onKeyDown(event) {
        var key = event.keyCode;
        var scale = book.centerContainer.scale;
        if(key == 87 || key == 38) {
          book.centerContainer.scale.set(scale.x+=0.1, scale.y +=0.1, scale.z += 0.1);
          //book.centerContainer.translateZ(10);
        }
        else if(key == 83 || key == 40) {
          book.centerContainer.scale.set(scale.x-=0.1, scale.y -=0.1, scale.z -= 0.1);
          //book.centerContainer.translateZ(-10);
        }
        /*else if(key == 65) {
          //book.centerContainer.position.x += 1;
          book.centerContainer.translateX(-10);
        }
        else if(key == 68) {
          book.centerContainer.translateX(10);
        }*/
        //book.centerContainer.position.z += 1;
      }

      function onKeyUp(event) {
      }

      function onMousemoveForMag(event) {
        clientX = event.clientX;
        clientY = event.clientY;
        var mousex = ((event.clientX / w) * 2 - 1);
				var mousey = - ((event.clientY / h) * 2 - 1);
        var vec = new THREE.Vector3(mousex, mousey, 0);
        projector.unprojectVector(vec, camera);
        var raycaster = new THREE.Raycaster(camera.position, vec.sub(camera.position).normalize());
        //var intersects = raycaster.intersectObjects(book.pages, true);
        var intersects = raycaster.intersectObject(book, true);
        if(intersects.length) {
          var pos = intersects[0].point;
          //console.log(camera.position);
          //var dir_vec = vec.sub(camera.position).normalize();
          //console.log(dir_vec);
          //var ray = new THREE.Raycaster(camera.position, dir_vec);
          //var distance = -camera.position.z / dir_vec.z;
          //var pos = camera.position.clone().add(dir_vec.multiplyScalar(distance));
          //console.log(pos);
          mag_cam.position.set(pos.x+25, pos.y, 10);
        }
      }

			function onDocumentMouseMove( event ) {

				/*mouseX = event.clientX - w2;
				mouseY = event.clientY - h2;

				targetRotationY = targetRotationOnMouseDownY + ( mouseX - mouseXOnMouseDown ) * 0.02;
				targetRotationX = targetRotationOnMouseDownX + ( mouseY - mouseYOnMouseDown ) * 0.02;*/
				//var target=
				//mouse_path.push(e.seenas.ray);
				mouseX=(( event.clientX / w ) * 2 - 1);
				targetRotationY=mouseX;
				mouseY=(( event.clientY / h ) * 2 - 1);
				targetRotationX=mouseY;
			}

			function onDocumentMouseUp( event ) {
				container.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				container.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				container.removeEventListener( 'mouseout', onDocumentMouseOut, false );
			}
			

			function onDocumentMouseOut( event ) {

				container.removeEventListener( 'mousemove', onDocumentMouseMove, false );
				container.removeEventListener( 'mouseup', onDocumentMouseUp, false );
				container.removeEventListener( 'mouseout', onDocumentMouseOut, false );
			}
			//

			function animate() {

				requestAnimationFrame( animate );

				render();
			}
			
			function render2()
			{
        var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
				TWEEN.update();
        // setViewport parameters:
        //  lower_left_x, lower_left_y, viewport_width, viewport_height
        renderer.setViewport(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
        renderer.clear(); 

        // left side
        renderer.setViewport( 1, 1, SCREEN_WIDTH - 200, SCREEN_HEIGHT);
        renderer.render( scene, camera);

        // right side
        if(magnify) {
          renderer.setViewport(SCREEN_WIDTH - 300, 50, 200, 200);
          renderer.render( scene, mag_cam);
        }

			}
			
			function render() {

				var multx=0.5*Math.PI;
				var multy=-Math.PI;
				camera.position.x = rad * Math.sin( targetRotationY*multy ) * Math.cos( targetRotationX*multx );
				camera.position.y = rad * Math.sin( targetRotationX*multx );
				camera.position.z = rad * Math.cos( targetRotationY*multy ) * Math.cos( targetRotationX*multx );
				camera.lookAt(scene.position);
				render2();
			}
		</script>
</body></html>
